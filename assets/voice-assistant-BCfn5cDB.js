import"./modulepreload-polyfill-B5Qt9EMX.js";import{G as l,M as d}from"./index-2Qi4geEX.js";import{f as u}from"./index.esm-DYxK39bG.js";const p={apiKey:"AIzaSyDMEemyDYqmbQauU7cgRKQ7cW9BARQAXDg",authDomain:"abidjansolution0006.firebaseapp.com",projectId:"abidjansolution0006"};u.apps.length||u.initializeApp(p);function h(a){let t="";for(let i=0;i<a.byteLength;i++)t+=String.fromCharCode(a[i]);return btoa(t)}function f(a){const t=atob(a),i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return i}async function g(a,t,i,e){const o=new Int16Array(a.buffer),s=t.createBuffer(e,o.length/e,i);for(let n=0;n<e;n++){const r=s.getChannelData(n);for(let c=0;c<s.length;c++)r[c]=o[c*e+n]/32768}return s}class m{constructor(){this.session=null,this.sessionPromise=null,this.isListening=!1,this.inputAudioContext=null,this.outputAudioContext=null,this.nextStartTime=0,this.sources=new Set,this.transcript="",this.ai=new l({apiKey:"AIzaSyBQyQZu16g-cBuBlrzbobTWfkLpijMXNjs"}),window.addEventListener("message",t=>t.data.command==="toggleListening"&&this.toggleListening()),this.postState("idle")}postState(t){parent.postMessage({type:"voiceStateUpdate",payload:{state:t}},"*")}postFeedback(t){parent.postMessage({type:"voiceFeedback",payload:{message:t}},"*")}async toggleListening(){this.isListening?this.stopSession():await this.startSession()}async startSession(){this.isListening=!0,this.postState("listening");try{const t=await navigator.mediaDevices.getUserMedia({audio:!0});this.inputAudioContext=new AudioContext({sampleRate:16e3}),this.outputAudioContext=new AudioContext({sampleRate:24e3}),this.sessionPromise=this.ai.live.connect({model:"gemini-2.5-flash-native-audio-preview-12-2025",config:{responseModalities:[d.AUDIO],systemInstruction:"Tu es AbidjanBot, l'assistant vocal d'Abidjan Solution. Parle UNIQUEMENT en français. SI l'utilisateur te dit 'Salue-moi', réponds EXACTEMENT: 'Bonjour ! Je suis l'assistant vocal de Abidjan Solution. Comment puis-je vous aider aujourd'hui ?'.",inputAudioTranscription:{},speechConfig:{voiceConfig:{prebuiltVoiceConfig:{voiceName:"Zephyr"}}}},callbacks:{onopen:()=>{var o;const i=this.inputAudioContext.createMediaStreamSource(t),e=this.inputAudioContext.createScriptProcessor(4096,1,1);e.onaudioprocess=s=>{var r;const n=s.inputBuffer.getChannelData(0);(r=this.sessionPromise)==null||r.then(c=>c.sendRealtimeInput({media:this.createBlob(n)}))},i.connect(e),e.connect(this.inputAudioContext.destination),(o=this.sessionPromise)==null||o.then(s=>s.send({text:"Salue-moi"})),this.postFeedback("Initialisation...")},onmessage:i=>this.handleLiveMessage(i),onerror:()=>this.stopSession(),onclose:()=>this.stopSession()}}),this.session=await this.sessionPromise}catch{this.stopSession()}}stopSession(){var t;this.isListening=!1,(t=this.session)==null||t.close(),this.postState("idle")}async handleLiveMessage(t){var i,e,o,s,n,r;(i=t.serverContent)!=null&&i.inputTranscription&&(this.transcript+=t.serverContent.inputTranscription.text+" "),(n=(s=(o=(e=t.serverContent)==null?void 0:e.modelTurn)==null?void 0:o.parts[0])==null?void 0:s.inlineData)!=null&&n.data&&this.playAudio(t.serverContent.modelTurn.parts[0].inlineData.data),(r=t.serverContent)!=null&&r.turnComplete&&this.transcript.trim().length>3&&(await this.saveVocalLead(this.transcript,"Réponse vocale transmise"),this.transcript="")}async saveVocalLead(t,i){try{console.log("[VOICE-DEBUG] Envoi lead vocal..."),await fetch("https://us-central1-abidjansolution0006.cloudfunctions.net/saveLeadAndNotify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:"Client Vocal",contact:"Voix",request:t,reponse:i,source:"Assistant_Vocal"})}),console.log("[VOICE-DEBUG] Succès !")}catch(e){console.error("Erreur sauvegarde lead vocal",e)}}async playAudio(t){if(!this.outputAudioContext)return;this.postState("speaking"),this.nextStartTime=Math.max(this.nextStartTime,this.outputAudioContext.currentTime);const i=await g(f(t),this.outputAudioContext,24e3,1),e=this.outputAudioContext.createBufferSource();e.buffer=i,e.connect(this.outputAudioContext.destination),e.start(this.nextStartTime),this.nextStartTime+=i.duration,this.sources.add(e),e.onended=()=>{this.sources.delete(e),this.sources.size===0&&this.postState("idle")}}createBlob(t){const i=new Int16Array(t.length);for(let e=0;e<t.length;e++)i[e]=t[e]*32768;return{data:h(new Uint8Array(i.buffer)),mimeType:"audio/pcm;rate=16000"}}}new m;
